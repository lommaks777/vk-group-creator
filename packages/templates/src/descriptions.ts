import Handlebars from 'handlebars';
import { StudentData, GroupDescriptionTemplate } from './types';

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è Handlebars
Handlebars.registerHelper('formatPrice', (price: number) => {
  return new Intl.NumberFormat('ru-RU', {
    style: 'currency',
    currency: 'RUB',
    minimumFractionDigits: 0,
  }).format(price);
});

Handlebars.registerHelper('joinTechniques', (techniques: string[]) => {
  return techniques.join(', ');
});

Handlebars.registerHelper('formatPhone', (phone: string) => {
  return phone.replace(/(\d{1})(\d{3})(\d{3})(\d{2})(\d{2})/, '$1 ($2) $3-$4-$5');
});

const homeVisitTemplate = Handlebars.compile(`
üè† **{{name}} - –ú–∞—Å—Å–∞–∂ –Ω–∞ –¥–æ–º—É –≤ {{city}}**

üìç **–†–∞–π–æ–Ω:** {{area}}
üìû **–¢–µ–ª–µ—Ñ–æ–Ω:** {{formatPhone phone}}
{{#if telegram}}üí¨ **Telegram:** {{telegram}}{{/if}}

**–£—Å–ª—É–≥–∏:**
{{#each pricing}}
‚Ä¢ {{title}} - {{formatPrice price}}
{{/each}}

**–¢–µ—Ö–Ω–∏–∫–∏:** {{joinTechniques techniques}}

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
‚úÖ –í—ã–µ–∑–¥ –Ω–∞ –¥–æ–º –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è
‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
‚úÖ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥
‚úÖ –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å

**–ö–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–µ–∞–Ω—Å:**
1. –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω
2. –í—ã–±–æ—Ä —Ç–µ—Ö–Ω–∏–∫–∏ –º–∞—Å—Å–∞–∂–∞
3. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–∞—Å–µ–ª
4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É

**–ü–æ–∫–∞–∑–∞–Ω–∏—è:**
‚Ä¢ –°—Ç—Ä–µ—Å—Å –∏ —É—Å—Ç–∞–ª–æ—Å—Ç—å
‚Ä¢ –ë–æ–ª–∏ –≤ —Å–ø–∏–Ω–µ –∏ —à–µ–µ
‚Ä¢ –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≤ –º—ã—à—Ü–∞—Ö
‚Ä¢ –ù–∞—Ä—É—à–µ–Ω–∏–µ —Å–Ω–∞
‚Ä¢ –û–±—â–µ–µ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–º–∞

**–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è:**
‚Ä¢ –û—Å—Ç—Ä—ã–µ –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
‚Ä¢ –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
‚Ä¢ –ö–æ–∂–Ω—ã–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è
‚Ä¢ –û–Ω–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è
‚Ä¢ –ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è)

**–ó–∞–ø–∏—Å—å:** {{formatPhone phone}}{{#if telegram}} –∏–ª–∏ {{telegram}}{{/if}}

#–º–∞—Å—Å–∞–∂ #{{city}} #{{area}} #–º–∞—Å—Å–∞–∂–Ω–∞–¥–æ–º #–∑–¥–æ—Ä–æ–≤—å–µ #—Ä–µ–ª–∞–∫—Å
`);

const officeTemplate = Handlebars.compile(`
üè¢ **{{name}} - –ú–∞—Å—Å–∞–∂–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤ {{city}}**

üìç **–ê–¥—Ä–µ—Å:** {{address}}
üìû **–¢–µ–ª–µ—Ñ–æ–Ω:** {{formatPhone phone}}
{{#if telegram}}üí¨ **Telegram:** {{telegram}}{{/if}}

**–£—Å–ª—É–≥–∏:**
{{#each pricing}}
‚Ä¢ {{title}} - {{formatPrice price}}
{{/each}}

**–¢–µ—Ö–Ω–∏–∫–∏:** {{joinTechniques techniques}}

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
‚úÖ –£—é—Ç–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞
‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
‚úÖ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥
‚úÖ –ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞

**–ö–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–µ–∞–Ω—Å:**
1. –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω
2. –í—ã–±–æ—Ä —Ç–µ—Ö–Ω–∏–∫–∏ –º–∞—Å—Å–∞–∂–∞
3. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–∞—Å–µ–ª
4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É

**–ü–æ–∫–∞–∑–∞–Ω–∏—è:**
‚Ä¢ –°—Ç—Ä–µ—Å—Å –∏ —É—Å—Ç–∞–ª–æ—Å—Ç—å
‚Ä¢ –ë–æ–ª–∏ –≤ —Å–ø–∏–Ω–µ –∏ —à–µ–µ
‚Ä¢ –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –≤ –º—ã—à—Ü–∞—Ö
‚Ä¢ –ù–∞—Ä—É—à–µ–Ω–∏–µ —Å–Ω–∞
‚Ä¢ –û–±—â–µ–µ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–º–∞

**–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è:**
‚Ä¢ –û—Å—Ç—Ä—ã–µ –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
‚Ä¢ –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
‚Ä¢ –ö–æ–∂–Ω—ã–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è
‚Ä¢ –û–Ω–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è
‚Ä¢ –ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è)

**–ó–∞–ø–∏—Å—å:** {{formatPhone phone}}{{#if telegram}} –∏–ª–∏ {{telegram}}{{/if}}

#–º–∞—Å—Å–∞–∂ #{{city}} #{{area}} #–º–∞—Å—Å–∞–∂–Ω—ã–π–∫–∞–±–∏–Ω–µ—Ç #–∑–¥–æ—Ä–æ–≤—å–µ #—Ä–µ–ª–∞–∫—Å
`);

export function generateGroupDescription(studentData: StudentData): GroupDescriptionTemplate {
  const description = studentData.is_home_visit 
    ? homeVisitTemplate(studentData)
    : officeTemplate(studentData);

  return {
    title: `–ú–∞—Å—Å–∞–∂ ‚Ä¢ ${studentData.city} ‚Ä¢ ${studentData.name}`,
    description: description.trim(),
    public_category: 1, // –ë–∏–∑–Ω–µ—Å –∏ —É—Å–ª—É–≥–∏
    public_subcategory: 1, // –ö—Ä–∞—Å–æ—Ç–∞ –∏ –∑–¥–æ—Ä–æ–≤—å–µ
  };
}
